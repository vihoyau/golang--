# Redis核心技术与实践

## 01基本架构：一个键值数据库包含什么？

### 系统观

- redis经常被用于缓存、秒杀、分布式锁等场景的重要基础。
- 可以存哪些数据？

	- KV，string、哈希表、列表、集合等。Redis能够在实际业务场景中得到广泛应用个，多得支持多样化类型的value

- 可以对数据做什么操作？

	- PUT、GET、DELETE
	- 有些健值数据库的新写/更新操作叫SET
	- 基本集合：SCAN等

- 健值对保持在内存还是外存？

	- 内存短电，外存磁盘慢。

- 如何设计，考虑健值数据库的主要应用场景？

	- 一个健值数据库包括了访问框架、索引模块、操作模块和存储模块。

- 采用什么访问模式？

	- 通过函数库调用的方式供外部使用。
	- 通过网络框架以Socket通信的形式对外提供健值对操作。

- 发送给健值数据库流程

	- 网络连接的处理、网络请求的解析，以及数据存取的处理，是用一个线程、多个线程，还是多个进程来交互处理呢？

		- 网络链接

	- 索引的作用是让健值数据库根据key找到相应的value的存储位置，进而执行操作。

- 不同操作的具体逻辑是怎么样的？

	- 对GET/SCAN操作而言，此时根据value的存储位置返回value值即可。

- 如何实现重启后快速提供服务？

	- 内存分配器glibc的malloc和free。
	- 分配器是健值数据库中的一个关键因素。对于以内存存储为主的Redis而言，这点尤为重要。redis的内存分配器提供了多种选择，分配效率也不一样。
	- 对健值对，落盘保存，数据更加可靠。
	- 周期性保存到文件只能够，避免频繁写入导致性能影响。

- SimpleKV演进到Reids

	- Redis主要通过网络框架进行访问，而不再是动态库了。
	- Redis数据模型中的value类型很丰富，因此也带来了更多的操作借口。
	- 日志（AOF）和快照（RDB）
	- 提供可靠性集群和高可扩展集群。

## 02数据结构：快速的Redis有哪些慢操作？

### 内存数据库，所有操作都在内存上完成，内存的访问速度本身就很快。另一方面，这要归功与它的数据结构。键值对按一定的数据结构来组织的，操作键值对最终是通过对数组结构进行增删改查。

### 底层数据结构一共有6种，分别是简单动态字符串、双向链表、压缩列表、哈希表、跳表和整数数组。

- List、Hash、Set、Sorted Set

### 键值用什么结构组织？

- 哈希桶
- 大量数据进入，哈希表的冲突问题和rehash可能带来的操作阻塞

### 为什么哈希表操作变慢了？

- 同时落在一个桶里面了。
- 哈希冲突链上的元素只能通过指针逐个查找再操作。
- Redis对哈希表做rehash操作。也增加哈希桶数量，让逐渐增多的entry元素能在更多的桶之间分散保存，减少单个桶中的元素数量，从而减少单个桶的中的冲突。
- rehash

	- 1.给哈希表2分配更大的空间，当前哈希表1大小的两倍
	- 2.把哈希表1中的数据重新映射到哈希表2.拷贝
	- 3.释放哈希表1的空间

- 如果大量的数据拷贝，会导致线程阻塞。

### 渐进式rehash

- 分次拷贝。避免了好使操作，保证了数据的快速访问。

### 集合数据操作效率

- 哈希表实现的集合，要比使用hash表实现的集合访问效率更高。其次，操作效率和这些操作本身的执行特点有关，比如读写一个元素要比读写所有元素的效率要高。

### 有哪些底层数据结构？

- 整数集合、hash表、跳表、双向链表、压缩列表
- 数组中的每一个元素都对应保存一个数据。和数组不同的是，压缩列表在表头有3个字段，分别是列表长度、列表尾的偏移量和列表中的entry个数；压缩列表在表尾海域zlend，表示列表结束。
- 跳表

	- 增加多级索引，通过索引位置的几个跳转，实现数据的快速定位。
	- 从第一个元素开始，每两个元素选一个出来作为索引。这些索引再通过指针指向原始的链表。例如，从前两个元素中抽取元素1作为一级索引，从第三、第四个元素中抽取元素11作为一级索引。只需要4次查找就能定位到元素33了。
	- 查找过程是多级索引上跳来跳去，最火定位到元素。跳表查找复杂度就是O（logn）

### 不同操作的复杂度

- 单元素操作是基础

	- 每一种集合类型对单个数据实现的增删改查操作。Hash类型的HGET、HSET和HDEL。

- 范围操作非常耗时

	- 范围操作，是指集合类型中的遍历操作，可以遍历集合中的所有数据。
	- 尽量避免，非常耗时。O（n）

- 统计操作通常高效

	- 集合类型对集合中所有元素个数的记录
	- 只有O（1）

- 例外情况至于哦几个

	- 压缩列表和双向链表都会记录表头和表尾的偏移量。

### 小结

- 支持集合类型实现，全局哈希表。双向链表，跳表。
- O（1）复杂度的哈希表被广泛使用，包括String、Hash和Set，它们的操作复杂度基本由hash表决定，另一方面，Sorted Set也采用了O（logN）复杂度的跳表。
- 遍历采用其他命令来代替，SCAN可以避免全集合遍历操作。
- 因地制宜使用List类型。POP/PUSH销量很高，那么在FIFO队列场景，而不是作为一个可以随机读写的集合。

## 分支主题 3

*XMind - Trial Version*